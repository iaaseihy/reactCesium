import when from"../ThirdParty/when.js";import BoundingSphere from"./BoundingSphere.js";import Cartesian3 from"./Cartesian3.js";import Check from"./Check.js";import defaultValue from"./defaultValue.js";import defined from"./defined.js";import DeveloperError from"./DeveloperError.js";import GeographicProjection from"./GeographicProjection.js";import HeightmapEncoding from"./HeightmapEncoding.js";import HeightmapTessellator from"./HeightmapTessellator.js";import CesiumMath from"./Math.js";import OrientedBoundingBox from"./OrientedBoundingBox.js";import Rectangle from"./Rectangle.js";import TaskProcessor from"./TaskProcessor.js";import TerrainData from"./TerrainData.js";import TerrainEncoding from"./TerrainEncoding.js";import TerrainMesh from"./TerrainMesh.js";import TerrainProvider from"./TerrainProvider.js";function HeightmapTerrainData(e){if(!defined(e)||!defined(e.buffer))throw new DeveloperError("options.buffer is required.");if(!defined(e.width))throw new DeveloperError("options.width is required.");if(!defined(e.height))throw new DeveloperError("options.height is required.");this._buffer=e.buffer,this._width=e.width,this._height=e.height,this._childTileMask=defaultValue(e.childTileMask,15),this._encoding=defaultValue(e.encoding,HeightmapEncoding.NONE);var t=HeightmapTessellator.DEFAULT_STRUCTURE,i=e.structure;defined(i)?i!==t&&(i.heightScale=defaultValue(i.heightScale,t.heightScale),i.heightOffset=defaultValue(i.heightOffset,t.heightOffset),i.elementsPerHeight=defaultValue(i.elementsPerHeight,t.elementsPerHeight),i.stride=defaultValue(i.stride,t.stride),i.elementMultiplier=defaultValue(i.elementMultiplier,t.elementMultiplier),i.isBigEndian=defaultValue(i.isBigEndian,t.isBigEndian)):i=t,this._structure=i,this._createdByUpsampling=defaultValue(e.createdByUpsampling,!1),this._waterMask=e.waterMask,this._skirtHeight=void 0,this._bufferType=this._encoding===HeightmapEncoding.LERC?Float32Array:this._buffer.constructor,this._mesh=void 0}Object.defineProperties(HeightmapTerrainData.prototype,{credits:{get:function(){}},waterMask:{get:function(){return this._waterMask}},childTileMask:{get:function(){return this._childTileMask}}});var createMeshTaskName="createVerticesFromHeightmap",createMeshTaskProcessorNoThrottle=new TaskProcessor(createMeshTaskName),createMeshTaskProcessorThrottle=new TaskProcessor(createMeshTaskName,TerrainData.maximumAsynchronousTasks);function interpolateHeight(e,t,i,r,n,o,h,s,a,d){var g=(a-o.west)*(h-1)/(o.east-o.west),l=(d-o.south)*(s-1)/(o.north-o.south),c=0|g,u=c+1;u>=h&&(u=h-1,c=h-2);var p=0|l,f=p+1;return f>=s&&(f=s-1,p=s-2),f=s-1-f,triangleInterpolateHeight(g-c,l-p,getHeight(e,t,i,r,n,(p=s-1-p)*h+c),getHeight(e,t,i,r,n,p*h+u),getHeight(e,t,i,r,n,f*h+c),getHeight(e,t,i,r,n,f*h+u))}function interpolateMeshHeight(e,t,i,r,n,o,h,s,a,d){var g=(s-n.west)*(o-1)/(n.east-n.west),l=(a-n.south)*(h-1)/(n.north-n.south),c=0|g,u=c+1;u>=o&&(u=o-1,c=o-2);var p=0|l,f=p+1;f>=h&&(f=h-1,p=h-2);var m=l-p;return p=h-1-p,f=h-1-f,triangleInterpolateHeight(g-c,m,(t.decodeHeight(e,p*o+c)/d-i)/r,(t.decodeHeight(e,p*o+u)/d-i)/r,(t.decodeHeight(e,f*o+c)/d-i)/r,(t.decodeHeight(e,f*o+u)/d-i)/r)}function triangleInterpolateHeight(e,t,i,r,n,o){return t<e?i+e*(r-i)+t*(o-r):i+e*(o-n)+t*(n-i)}function getHeight(e,t,i,r,n,o){o*=r;var h,s=0;if(n)for(h=0;h<t;++h)s=s*i+e[o+h];else for(h=t-1;h>=0;--h)s=s*i+e[o+h];return s}function setHeight(e,t,i,r,n,o,h,s){var a;if(h*=n,o)for(a=0;a<t-1;++a)e[h+a]=s/r|0,s-=e[h+a]*r,r/=i;else for(a=t-1;a>0;--a)e[h+a]=s/r|0,s-=e[h+a]*r,r/=i;e[h+a]=s}HeightmapTerrainData.prototype.createMesh=function(e){e=defaultValue(e,defaultValue.EMPTY_OBJECT),Check.typeOf.object("options.tilingScheme",e.tilingScheme),Check.typeOf.number("options.x",e.x),Check.typeOf.number("options.y",e.y),Check.typeOf.number("options.level",e.level);var t=e.tilingScheme,i=e.x,r=e.y,n=e.level,o=defaultValue(e.exaggeration,1),h=defaultValue(e.throttle,!0),s=t.ellipsoid,a=t.tileXYToNativeRectangle(i,r,n),d=t.tileXYToRectangle(i,r,n),g=s.cartographicToCartesian(Rectangle.center(d)),l=this._structure,c=TerrainProvider.getEstimatedLevelZeroGeometricErrorForAHeightmap(s,this._width,t.getNumberOfXTilesAtLevel(0))/(1<<n);this._skirtHeight=Math.min(4*c,1e3);var u=(h?createMeshTaskProcessorThrottle:createMeshTaskProcessorNoThrottle).scheduleTask({heightmap:this._buffer,structure:l,includeWebMercatorT:!0,width:this._width,height:this._height,nativeRectangle:a,rectangle:d,relativeToCenter:g,ellipsoid:s,skirtHeight:this._skirtHeight,isGeographic:t.projection instanceof GeographicProjection,exaggeration:o,encoding:this._encoding});if(defined(u)){var p=this;return when(u,(function(e){var t;t=p._skirtHeight>0?TerrainProvider.getRegularGridAndSkirtIndicesAndEdgeIndices(e.gridWidth,e.gridHeight):TerrainProvider.getRegularGridIndicesAndEdgeIndices(e.gridWidth,e.gridHeight);var i=e.gridWidth*e.gridHeight;return p._mesh=new TerrainMesh(g,new Float32Array(e.vertices),t.indices,t.indexCountWithoutSkirts,i,e.minimumHeight,e.maximumHeight,BoundingSphere.clone(e.boundingSphere3D),Cartesian3.clone(e.occludeePointInScaledSpace),e.numberOfAttributes,OrientedBoundingBox.clone(e.orientedBoundingBox),TerrainEncoding.clone(e.encoding),o,t.westIndicesSouthToNorth,t.southIndicesEastToWest,t.eastIndicesNorthToSouth,t.northIndicesWestToEast),p._buffer=void 0,p._mesh}))}},HeightmapTerrainData.prototype._createMeshSync=function(e){Check.typeOf.object("options.tilingScheme",e.tilingScheme),Check.typeOf.number("options.x",e.x),Check.typeOf.number("options.y",e.y),Check.typeOf.number("options.level",e.level);var t=e.tilingScheme,i=e.x,r=e.y,n=e.level,o=defaultValue(e.exaggeration,1),h=t.ellipsoid,s=t.tileXYToNativeRectangle(i,r,n),a=t.tileXYToRectangle(i,r,n),d=h.cartographicToCartesian(Rectangle.center(a)),g=this._structure,l=TerrainProvider.getEstimatedLevelZeroGeometricErrorForAHeightmap(h,this._width,t.getNumberOfXTilesAtLevel(0))/(1<<n);this._skirtHeight=Math.min(4*l,1e3);var c,u=HeightmapTessellator.computeVertices({heightmap:this._buffer,structure:g,includeWebMercatorT:!0,width:this._width,height:this._height,nativeRectangle:s,rectangle:a,relativeToCenter:d,ellipsoid:h,skirtHeight:this._skirtHeight,isGeographic:t.projection instanceof GeographicProjection,exaggeration:o});this._buffer=void 0,c=this._skirtHeight>0?TerrainProvider.getRegularGridAndSkirtIndicesAndEdgeIndices(this._width,this._height):TerrainProvider.getRegularGridIndicesAndEdgeIndices(this._width,this._height);var p=u.gridWidth*u.gridHeight;return new TerrainMesh(d,u.vertices,c.indices,c.indexCountWithoutSkirts,p,u.minimumHeight,u.maximumHeight,u.boundingSphere3D,u.occludeePointInScaledSpace,u.encoding.getStride(),u.orientedBoundingBox,u.encoding,o,c.westIndicesSouthToNorth,c.southIndicesEastToWest,c.eastIndicesNorthToSouth,c.northIndicesWestToEast)},HeightmapTerrainData.prototype.interpolateHeight=function(e,t,i){var r=this._width,n=this._height,o=this._structure,h=o.stride,s=o.elementsPerHeight,a=o.elementMultiplier,d=o.isBigEndian,g=o.heightOffset,l=o.heightScale,c=defined(this._mesh),u=this._encoding===HeightmapEncoding.LERC;if(!(!c&&u)){var p;if(c)p=interpolateMeshHeight(this._mesh.vertices,this._mesh.encoding,g,l,e,r,n,t,i,this._mesh.exaggeration);else p=(p=interpolateHeight(this._buffer,s,a,h,d,e,r,n,t,i))*l+g;return p}},HeightmapTerrainData.prototype.upsample=function(e,t,i,r,n,o,h){if(!defined(e))throw new DeveloperError("tilingScheme is required.");if(!defined(t))throw new DeveloperError("thisX is required.");if(!defined(i))throw new DeveloperError("thisY is required.");if(!defined(r))throw new DeveloperError("thisLevel is required.");if(!defined(n))throw new DeveloperError("descendantX is required.");if(!defined(o))throw new DeveloperError("descendantY is required.");if(!defined(h))throw new DeveloperError("descendantLevel is required.");if(h-r>1)throw new DeveloperError("Upsampling through more than one level at a time is not currently supported.");var s=this._mesh;if(defined(s)){for(var a=this._width,d=this._height,g=this._structure,l=g.stride,c=new this._bufferType(a*d*l),u=s.vertices,p=s.encoding,f=e.tileXYToRectangle(t,i,r),m=e.tileXYToRectangle(n,o,h),T=g.heightOffset,v=g.heightScale,w=s.exaggeration,H=g.elementsPerHeight,_=g.elementMultiplier,E=g.isBigEndian,k=Math.pow(_,H-1),M=0;M<d;++M)for(var y=CesiumMath.lerp(m.north,m.south,M/(d-1)),D=0;D<a;++D){var S=interpolateMeshHeight(u,p,T,v,f,a,d,CesiumMath.lerp(m.west,m.east,D/(a-1)),y,w);setHeight(c,H,_,k,l,E,M*a+D,S=(S=S<g.lowestEncodedHeight?g.lowestEncodedHeight:S)>g.highestEncodedHeight?g.highestEncodedHeight:S)}return new HeightmapTerrainData({buffer:c,width:a,height:d,childTileMask:0,structure:this._structure,createdByUpsampling:!0})}},HeightmapTerrainData.prototype.isChildAvailable=function(e,t,i,r){if(!defined(e))throw new DeveloperError("thisX is required.");if(!defined(t))throw new DeveloperError("thisY is required.");if(!defined(i))throw new DeveloperError("childX is required.");if(!defined(r))throw new DeveloperError("childY is required.");var n=2;return i!==2*e&&++n,r!==2*t&&(n-=2),0!==(this._childTileMask&1<<n)},HeightmapTerrainData.prototype.wasCreatedByUpsampling=function(){return this._createdByUpsampling};export default HeightmapTerrainData;